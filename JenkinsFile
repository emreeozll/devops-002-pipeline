pipeline {
    agent any

    tools{
        jdk 'JDK17'
        maven 'Maven3'
    }



    stages {
        stage('Build Maven') {
            steps {
                checkout scmGit(branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/emreeozll/devops-002-pipeline']])

                //sh 'mvn clean install'
                bat 'mvn clean install'
            }
        }



         stage('Unit Test') {
             steps{

                           //sh 'mvn test'
                            bat 'mvn test'

                           //sh 'echo Docker Image to Clean'
                            bat 'echo Docker Image to Clean'

                   }
         }



           stage('Docker Image') {
            steps {
                checkout scmGit(branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/emreeozll/devops-002-pipeline']])

                //sh 'mvn clean install'
                bat 'docker build -t  emreeoozell/devops-application-002:v003   .'
            }
        }



        stage('Docker Image to DockerHub') {
            steps {
                //sh 'mvn clean install'
               script{

                withCredentials([string(credentialsId: 'DockerHubToken', variable: 'DockerHubToken')]){
                  // some block

                  bat ' echo docker login --username emreeoozell --password ${DockerHubToken}'

                  //bat 'docker build -t  emreeoozell/my-applications   .'  : aynısı var diye yorum satırına aldım

                   bat 'docker image push docker.io/emreeoozell/devops-application-002:v003'

                }
              }
           }
        }



         stage('Deploy Kubernetes') {
              steps{
               script{
                             kubernetesDeploy (configs: 'deploymentservice.yaml', kubeconfigId: 'Kubernetes')
                     }
               }
         }



          stage('Docker Imag to Clean') {
                steps {

                         bat ' echo docker rmi emreeoozell/devops-application-002:v003'
                     }
                }





    }
}
